version: "3"

services:
  base:
    image: chartjs-node-canvas-base
    build:
      context: .
      dockerfile: docker/base/Dockerfile
    container_name: chartjs-node-canvas-base
  build:
    image: chartjs-node-canvas-build
    depends_on: 
      - base
    build:
      context: .
      dockerfile: docker/build/Dockerfile
    container_name: chartjs-node-canvas-build
  test:
    image: chartjs-node-canvas-build
    container_name: chartjs-node-canvas-test
    volumes:
      - ./testData:/usr/server/testData
    depends_on: 
      - build
    environment:
      - NODE_ENV=test
      - FONTCONFIG_PATH=/etc/fonts
    command: npm run test
  production:
    image: chartjs-node-canvas
    depends_on: 
      - test
    build:
      context: .
      dockerfile: docker/production/Dockerfile
    container_name: chartjs-node-canvas
    environment:
      - NODE_ENV=production
